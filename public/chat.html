<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Alpha Chat</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0a0a0a; --surface: #111; --surface2: #1a1a1a;
    --border: #222; --border2: #333;
    --text: #e0e0e0; --text2: #888; --text3: #555;
    --accent: #2563eb; --accent-hover: #1d4ed8;
    --user-bg: #1a2744; --assistant-bg: #161616;
  }
  html, body { height: 100%; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg); color: var(--text);
    display: flex; flex-direction: column; height: 100vh;
  }
  .header {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.6rem 1rem; border-bottom: 1px solid var(--border);
    background: var(--surface); flex-shrink: 0;
  }
  .header h1 { font-size: 1rem; color: #fff; white-space: nowrap; }
  .header select {
    background: var(--surface2); border: 1px solid var(--border2); color: var(--text);
    padding: 0.35rem 0.5rem; border-radius: 4px; font-size: 0.8rem;
  }
  .header .model-info { font-size: 0.7rem; color: var(--text3); }
  .header .spacer { flex: 1; }
  .header a { color: #60a5fa; text-decoration: none; font-size: 0.8rem; }
  .header a:hover { text-decoration: underline; }
  .header button {
    background: transparent; border: 1px solid var(--border2); color: var(--text2);
    padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
  }
  .header button:hover { background: var(--surface2); color: var(--text); }
  .settings {
    display: none; padding: 0.5rem 1rem; background: var(--surface);
    border-bottom: 1px solid var(--border); flex-shrink: 0;
    gap: 1rem; align-items: center; flex-wrap: wrap;
  }
  .settings.open { display: flex; }
  .settings label { font-size: 0.75rem; color: var(--text2); }
  .settings input {
    background: var(--surface2); border: 1px solid var(--border2); color: var(--text);
    padding: 0.3rem 0.4rem; border-radius: 3px; width: 4.5rem; font-size: 0.8rem;
  }
  .setting { display: flex; align-items: center; gap: 0.3rem; }
  .messages {
    flex: 1; overflow-y: auto; padding: 1rem 0;
    display: flex; flex-direction: column;
  }
  .message {
    max-width: 720px; width: 100%; margin: 0 auto; padding: 0.75rem 1.25rem;
  }
  .message.user { background: var(--user-bg); border-radius: 12px; margin-bottom: 0.5rem; align-self: center; }
  .message.assistant { background: var(--assistant-bg); margin-bottom: 0.5rem; }
  .message .role { font-size: 0.7rem; color: var(--text2); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; }
  .message .content {
    font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;
  }
  .message.assistant .content { font-family: "SF Mono", "Fira Code", monospace; font-size: 0.85rem; }
  .welcome {
    flex: 1; display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 0.5rem; color: var(--text3);
  }
  .welcome h2 { font-size: 1.2rem; color: var(--text2); font-weight: 400; }
  .welcome p { font-size: 0.85rem; }
  .input-area {
    border-top: 1px solid var(--border); padding: 0.75rem 1rem;
    background: var(--surface); flex-shrink: 0;
  }
  .input-row {
    max-width: 720px; margin: 0 auto;
    display: flex; gap: 0.5rem; align-items: flex-end;
  }
  .input-row textarea {
    flex: 1; background: var(--surface2); border: 1px solid var(--border2);
    color: var(--text); padding: 0.6rem 0.75rem; border-radius: 8px;
    font-size: 0.9rem; font-family: inherit; resize: none;
    min-height: 44px; max-height: 150px; line-height: 1.4;
  }
  .input-row textarea:focus { outline: none; border-color: var(--accent); }
  .input-row textarea::placeholder { color: var(--text3); }
  .input-row button.send {
    background: var(--accent); color: #fff; border: none;
    width: 40px; height: 40px; border-radius: 8px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    font-size: 1.1rem;
  }
  .input-row button.send:hover { background: var(--accent-hover); }
  .input-row button.send:disabled { background: #333; cursor: not-allowed; }
  .status-bar {
    max-width: 720px; margin: 0.3rem auto 0; font-size: 0.7rem; color: var(--text3); min-height: 1em;
  }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }
  .cursor { display: inline-block; width: 2px; height: 1em; background: var(--accent); animation: blink 0.8s infinite; vertical-align: text-bottom; margin-left: 1px; }
</style>
</head>
<body>
<div class="header">
  <h1>Alpha Chat</h1>
  <select id="model"></select>
  <span class="model-info" id="modelInfo"></span>
  <span class="spacer"></span>
  <button onclick="toggleSettings()">Settings</button>
  <button onclick="clearChat()">Clear</button>
  <a href="/">Inference UI</a>
</div>
<div class="settings" id="settings">
  <div class="setting"><label>Max tokens</label><input type="number" id="maxTokens" value="200" min="1" max="500"></div>
  <div class="setting"><label>Temperature</label><input type="number" id="temp" value="0.8" min="0.1" max="2.0" step="0.1"></div>
  <div class="setting"><label>Top-k</label><input type="number" id="topk" value="40" min="0" max="200"></div>
  <div class="setting"><label>Context msgs</label><input type="number" id="ctxMsgs" value="4" min="1" max="20"></div>
</div>
<div class="messages" id="messages">
  <div class="welcome">
    <h2>Alpha Chat</h2>
    <p>Select a model and start typing. These are base language models trained on text, not instruction-tuned.</p>
    <p>They work best as text continuations — type the beginning of a sentence or paragraph.</p>
  </div>
</div>
<div class="input-area">
  <div class="input-row">
    <textarea id="input" rows="1" placeholder="Type a message..." autofocus></textarea>
    <button class="send" id="sendBtn" onclick="sendMessage()">&#9654;</button>
  </div>
  <div class="status-bar" id="status"></div>
</div>
<script>
let models = [];
let chatHistory = [];
let abortController = null;
let generating = false;

async function loadModels() {
  const res = await fetch("/api/models");
  models = await res.json();
  const sel = document.getElementById("model");
  sel.innerHTML = "";
  for (const m of models) {
    const opt = document.createElement("option");
    const tag = m.domain || "novels";
    opt.value = m.id; opt.textContent = m.name + " [" + tag + "] (step " + m.step + ")";
    sel.appendChild(opt);
  }
  updateModelInfo();
}
function updateModelInfo() {
  const m = models.find(x => x.id === document.getElementById("model").value);
  if (!m) return;
  const mc = m.modelConfig;
  const domain = m.domain || "novels";
  const parts = [domain, mc.nLayer+"L "+mc.nEmbd+"D "+mc.nHead+"H", "vocab="+mc.vocabSize, "ctx="+mc.blockSize];
  if (m.lastLoss != null) parts.push("loss="+m.lastLoss.toFixed(3));
  document.getElementById("modelInfo").textContent = parts.join(" | ");
  // Adapt placeholder based on domain
  const input = document.getElementById("input");
  input.placeholder = domain === "chords" ? "Enter chord progression..." : "Type a message...";
}
document.getElementById("model").addEventListener("change", updateModelInfo);
function toggleSettings() { document.getElementById("settings").classList.toggle("open"); }
function clearChat() { chatHistory = []; renderMessages(); document.getElementById("status").textContent = ""; }
function renderMessages() {
  const container = document.getElementById("messages");
  if (chatHistory.length === 0) {
    container.innerHTML = '<div class="welcome"><h2>Alpha Chat</h2><p>Select a model and start typing. These are base language models trained on text, not instruction-tuned.</p><p>They work best as text continuations — type the beginning of a sentence or paragraph.</p></div>';
    return;
  }
  container.innerHTML = "";
  for (const msg of chatHistory) {
    const div = document.createElement("div");
    div.className = "message " + msg.role;
    div.innerHTML = '<div class="role">' + msg.role + '</div><div class="content"></div>';
    div.querySelector(".content").textContent = msg.content;
    container.appendChild(div);
  }
  container.scrollTop = container.scrollHeight;
}
async function sendMessage() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text || generating) return;
  chatHistory.push({ role: "user", content: text });
  input.value = ""; input.style.height = "auto";
  renderMessages();
  chatHistory.push({ role: "assistant", content: "" });
  renderMessages();
  const container = document.getElementById("messages");
  const lastMsg = container.querySelector(".message:last-child .content");
  lastMsg.innerHTML = '<span class="cursor"></span>';
  generating = true;
  document.getElementById("sendBtn").disabled = true;
  document.getElementById("status").textContent = "Generating...";
  const ctxMsgs = parseInt(document.getElementById("ctxMsgs").value) || 4;
  const apiMessages = chatHistory.slice(-(ctxMsgs + 1), -1);
  const maxTokens = parseInt(document.getElementById("maxTokens").value) || 200;
  const temperature = parseFloat(document.getElementById("temp").value) || 0.8;
  const topk = parseInt(document.getElementById("topk").value) || 40;
  abortController = new AbortController();
  const t0 = performance.now();
  let charCount = 0;
  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: apiMessages,
        model: document.getElementById("model").value,
        maxTokens, temperature, topk,
      }),
      signal: abortController.signal,
    });
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let assistantText = "";
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      assistantText += chunk; charCount += chunk.length;
      chatHistory[chatHistory.length - 1].content = assistantText;
      lastMsg.textContent = assistantText;
      const cursor = document.createElement("span");
      cursor.className = "cursor";
      lastMsg.appendChild(cursor);
      container.scrollTop = container.scrollHeight;
    }
    lastMsg.textContent = assistantText;
    const elapsed = ((performance.now() - t0) / 1000).toFixed(1);
    document.getElementById("status").textContent = charCount + " chars in " + elapsed + "s";
  } catch (e) {
    if (e.name !== "AbortError") {
      document.getElementById("status").textContent = "Error: " + e.message;
      if (chatHistory.length && chatHistory[chatHistory.length - 1].content === "") {
        chatHistory.pop(); renderMessages();
      }
    }
  }
  generating = false; abortController = null;
  document.getElementById("sendBtn").disabled = false;
}
const input = document.getElementById("input");
input.addEventListener("input", function() { this.style.height = "auto"; this.style.height = Math.min(this.scrollHeight, 150) + "px"; });
input.addEventListener("keydown", function(e) { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
loadModels();
</script>
</body>
</html>
